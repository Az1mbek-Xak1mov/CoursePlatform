# Upstream for the Django application
upstream django {
    server web:8000;
}

# --- Block 1: HTTP Redirect to HTTPS (Port 80) ---
server {
    listen 80;
    server_name yourdomain.tld www.yourdomain.tld; # CHANGE THIS TO YOUR DOMAIN
    
    # Redirect all HTTP traffic to HTTPS (Critical for security)
    return 301 https://$host$request_uri;
}


# --- Block 2: HTTPS Proxy Configuration (Port 443) ---
server {
    listen 443 ssl http2; # Listen on port 443
    server_name yourdomain.tld www.yourdomain.tld; # CHANGE THIS TO YOUR DOMAIN

    # --- SSL CONFIGURATION (You must generate/obtain these) ---
    # Replace these paths with your actual certificate and key files
    ssl_certificate /etc/nginx/ssl/yourdomain.crt; 
    ssl_certificate_key /etc/nginx/ssl/yourdomain.key;
    # --- END SSL CONFIGURATION ---
    
    client_max_body_size 100M;
    
    # Static and Media remain the same
    location /static/ {
        alias /app/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    location /media/ {
        alias /app/media/;
        expires 7d;
        add_header Cache-Control "public";
    }
    
    location / {
        proxy_pass http://django;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # *** CRITICAL FIX FOR CSRF/PROTOCOL MISMATCH ***
        # Since the user connected to Nginx over HTTPS, we explicitly
        # tell the Django application that the protocol was 'https'.
        proxy_set_header X-Forwarded-Proto https; 
        
        proxy_redirect off;
    }
}
