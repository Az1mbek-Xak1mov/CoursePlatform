{% extends 'base.html' %}
{% load static %}

{% block title %}{{ course.title }} - IlmSpace{% endblock %}

{% block extra_css %}
<style>
    .course-hero {
        background: var(--gradient-primary);
        color: white;
        padding: var(--space-8) 0;
    }
    
    .course-hero-grid {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: var(--space-8);
        align-items: start;
    }
    
    .course-meta {
        display: flex;
        flex-wrap: wrap;
        gap: var(--space-4);
        margin-bottom: var(--space-4);
    }
    
    .course-meta-item {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        font-size: 0.9rem;
    }
    
    .course-categories {
        display: flex;
        gap: var(--space-2);
        margin-bottom: var(--space-3);
    }
    
    .course-categories .badge {
        background: rgba(255,255,255,0.2);
        color: white;
    }
    
    .course-sidebar {
        background: var(--bg-primary);
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-xl);
        position: sticky;
        top: 100px;
    }
    
    .course-preview {
        position: relative;
        aspect-ratio: 16/9;
        background: var(--bg-tertiary);
    }
    
    .course-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .play-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 70px;
        height: 70px;
        background: rgba(255,255,255,0.9);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        cursor: pointer;
        transition: transform var(--transition-base);
    }
    
    .play-button:hover {
        transform: translate(-50%, -50%) scale(1.1);
    }
    
    .sidebar-content {
        padding: var(--space-5);
    }
    
    .price-tag {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: var(--space-4);
    }
    
    .course-includes {
        list-style: none;
        padding: 0;
        margin: var(--space-4) 0;
    }
    
    .course-includes li {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-2) 0;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    .course-includes li span {
        color: var(--primary);
    }
    
    /* Course Content Section */
    .course-content-section {
        padding: var(--space-8) 0;
    }
    
    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: var(--space-5);
    }
    
    /* What You'll Learn */
    .learning-outcomes {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-3);
    }
    
    .learning-outcome {
        display: flex;
        gap: var(--space-3);
        align-items: flex-start;
    }
    
    .learning-outcome span {
        color: var(--success);
        font-size: 1.2rem;
    }
    
    /* Curriculum */
    .curriculum-module {
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-3);
        overflow: hidden;
    }
    
    .module-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-4);
        background: var(--bg-secondary);
        cursor: pointer;
        transition: background var(--transition-fast);
    }
    
    .module-header:hover {
        background: var(--bg-tertiary);
    }
    
    .module-title {
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: var(--space-3);
    }
    
    .module-meta {
        font-size: 0.85rem;
        color: var(--text-tertiary);
    }
    
    .module-lessons {
        display: none;
        border-top: 1px solid var(--border);
    }
    
    .module-lessons.open {
        display: block;
    }
    
    .lesson-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-3) var(--space-4);
        border-bottom: 1px solid var(--border);
    }
    
    .lesson-item:last-child {
        border-bottom: none;
    }
    
    .lesson-info {
        display: flex;
        align-items: center;
        gap: var(--space-3);
    }
    
    .lesson-icon {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-secondary);
        border-radius: var(--radius-sm);
        font-size: 0.9rem;
    }
    
    .lesson-duration {
        font-size: 0.85rem;
        color: var(--text-tertiary);
    }
    
    .preview-badge {
        font-size: 0.75rem;
        padding: 2px 8px;
        background: var(--primary-light-bg);
        color: var(--primary);
        border-radius: var(--radius-full);
    }
    
    /* Reviews */
    .review-card {
        padding: var(--space-4);
        border-bottom: 1px solid var(--border);
    }
    
    .review-header {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        margin-bottom: var(--space-3);
    }
    
    .reviewer-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--gradient-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }
    
    .reviewer-info h4 {
        margin: 0;
        font-size: 1rem;
    }
    
    .review-rating {
        color: var(--warning);
    }
    
    .rating-bars {
        margin: var(--space-4) 0;
    }
    
    .rating-bar {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        margin-bottom: var(--space-2);
    }
    
    .rating-bar-fill {
        flex: 1;
        height: 8px;
        background: var(--bg-tertiary);
        border-radius: var(--radius-full);
        overflow: hidden;
    }
    
    .rating-bar-fill div {
        height: 100%;
        background: var(--warning);
    }
    
    /* Author Section */
    .author-card {
        display: flex;
        gap: var(--space-4);
        padding: var(--space-5);
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
    }
    
    .author-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: var(--gradient-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2.5rem;
        font-weight: 600;
    }
    
    .author-stats {
        display: flex;
        gap: var(--space-5);
        margin-top: var(--space-3);
    }
    
    .author-stat {
        text-align: center;
    }
    
    .author-stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary);
    }
    
    .author-stat-label {
        font-size: 0.8rem;
        color: var(--text-tertiary);
    }
    
    @media (max-width: 900px) {
        .course-hero-grid {
            grid-template-columns: 1fr;
        }
        
        .course-sidebar {
            position: static;
        }
        
        .learning-outcomes {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Course Hero -->
<div class="course-hero">
    <div class="container">
        <div class="course-hero-grid">
            <div>
                <div class="course-categories">
                    {% for cat in course.categories.all %}
                    <span class="badge">{{ cat.name }}</span>
                    {% endfor %}
                </div>
                
                <h1 class="mb-4">{{ course.title }}</h1>
                <p class="text-lg mb-4" style="color: rgba(255,255,255,0.9);">{{ course.short_description|default:course.description|truncatewords:30 }}</p>
                
                <div class="course-meta">
                    <div class="course-meta-item">
                        <span class="text-warning">‚òÖ</span>
                        <strong>{{ course.average_rating|floatformat:1 }}</strong>
                        <span>({{ course.review_count }} reviews)</span>
                    </div>
                    <div class="course-meta-item">
                        <span>üë•</span>
                        <span>{{ course.enrollment_count }} students</span>
                    </div>
                    <div class="course-meta-item">
                        <span>üìö</span>
                        <span>{{ total_lessons }} lessons</span>
                    </div>
                    <div class="course-meta-item">
                        <span>‚è±</span>
                        <span>{{ total_duration }} min total</span>
                    </div>
                </div>
                
                <div class="course-meta">
                    <div class="course-meta-item">
                        <span>üéØ</span>
                        <span>{{ course.get_level_display }}</span>
                    </div>
                    <div class="course-meta-item">
                        <span>üåê</span>
                        <span>{{ course.language|upper }}</span>
                    </div>
                    <div class="course-meta-item">
                        <span>üìÖ</span>
                        <span>Updated {{ course.updated_at|date:"M Y" }}</span>
                    </div>
                </div>
                
                <div class="mt-4" style="display: flex; align-items: center; gap: var(--space-3);">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center;">
                        {{ course.author.first_name.0 }}{{ course.author.last_name.0 }}
                    </div>
                    <div>
                        <div style="font-size: 0.9rem;">Created by</div>
                        <div style="font-weight: 600;">{{ course.author.get_full_name }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar (visible on desktop) -->
            <div class="course-sidebar">
                <div class="course-preview">
                    {% if course.thumbnail %}
                    <img src="{{ course.thumbnail.url }}" alt="{{ course.title }}">
                    {% endif %}
                    {% if course.trailer_url %}
                    <div class="play-button" onclick="playTrailer()">‚ñ∂</div>
                    {% endif %}
                </div>
                
                <div class="sidebar-content">
                    <div class="price-tag">
                        {% if course.price > 0 %}
                        {{ course.price|floatformat:0 }} UZS
                        {% else %}
                        Free
                        {% endif %}
                    </div>
                    
                    {% if is_enrolled %}
                    <a href="{% url 'course_learn' slug=course.slug %}" class="btn btn-primary btn-lg" style="width: 100%; margin-bottom: var(--space-3);">
                        Continue Learning
                    </a>
                    <p class="text-center text-muted text-sm">You're enrolled in this course</p>
                    {% else %}
                    <a href="{% url 'course_enroll' slug=course.slug %}" class="btn btn-primary btn-lg" style="width: 100%; margin-bottom: var(--space-3);">
                        {% if course.price > 0 %}Buy Now{% else %}Enroll for Free{% endif %}
                    </a>
                    {% endif %}
                    
                    <ul class="course-includes">
                        <li><span>üìπ</span> {{ total_lessons }} video lessons</li>
                        <li><span>‚è±</span> {{ total_duration }} minutes of content</li>
                        <li><span>üì±</span> Access on mobile and desktop</li>
                        <li><span>üèÜ</span> Certificate of completion</li>
                        <li><span>‚ôæÔ∏è</span> Full lifetime access</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Course Content -->
<div class="container course-content-section">
    <div style="max-width: 800px;">
        <!-- What You'll Learn -->
        {% if course.what_you_will_learn %}
        <section class="card mb-6" style="padding: var(--space-5);">
            <h2 class="section-title">What you'll learn</h2>
            <div class="learning-outcomes">
                {% for item in course.what_you_will_learn.splitlines %}
                {% if item.strip %}
                <div class="learning-outcome">
                    <span>‚úì</span>
                    <p style="margin: 0;">{{ item }}</p>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </section>
        {% endif %}
        
        <!-- Requirements -->
        {% if course.requirements %}
        <section class="mb-6">
            <h2 class="section-title">Requirements</h2>
            <ul>
                {% for item in course.requirements.splitlines %}
                {% if item.strip %}
                <li>{{ item }}</li>
                {% endif %}
                {% endfor %}
            </ul>
        </section>
        {% endif %}
        
        <!-- Course Curriculum -->
        <section class="mb-6">
            <h2 class="section-title">Course Curriculum</h2>
            <p class="text-muted mb-4">{{ modules|length }} sections ‚Ä¢ {{ total_lessons }} lessons ‚Ä¢ {{ total_duration }} min total length</p>
            
            {% for module in modules %}
            <div class="curriculum-module">
                <div class="module-header" onclick="toggleModule(this)">
                    <div class="module-title">
                        <span>üìÅ</span>
                        {{ module.title }}
                    </div>
                    <div class="module-meta">
                        {{ module.lessons.count }} lessons
                    </div>
                </div>
                <div class="module-lessons">
                    {% for lesson in module.lessons.all %}
                    <div class="lesson-item">
                        <div class="lesson-info">
                            <div class="lesson-icon">üìπ</div>
                            <div>
                                <div>{{ lesson.title }}</div>
                                {% if lesson.is_preview %}
                                <span class="preview-badge">Preview</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="lesson-duration">{{ lesson.duration_minutes }} min</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </section>
        
        <!-- Description -->
        <section class="mb-6">
            <h2 class="section-title">Description</h2>
            <div style="white-space: pre-line;">{{ course.description }}</div>
        </section>
        
        <!-- Instructor -->
        <section class="mb-6">
            <h2 class="section-title">Instructor</h2>
            <div class="author-card">
                <div class="author-avatar">
                    {{ course.author.first_name.0 }}{{ course.author.last_name.0 }}
                </div>
                <div>
                    <h3 style="margin: 0;">{{ course.author.get_full_name }}</h3>
                    <p class="text-muted">Course Instructor</p>
                    <div class="author-stats">
                        <div class="author-stat">
                            <div class="author-stat-value">‚òÖ 4.8</div>
                            <div class="author-stat-label">Rating</div>
                        </div>
                        <div class="author-stat">
                            <div class="author-stat-value">{{ course.author.courses.count }}</div>
                            <div class="author-stat-label">Courses</div>
                        </div>
                        <div class="author-stat">
                            <div class="author-stat-value">{{ course.enrollment_count }}</div>
                            <div class="author-stat-label">Students</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Reviews -->
        <section class="mb-6">
            <h2 class="section-title">Student Reviews</h2>
            
            <div class="card mb-4" style="padding: var(--space-5);">
                <div style="display: flex; align-items: center; gap: var(--space-6);">
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; font-weight: 700; color: var(--warning);">{{ course.average_rating|floatformat:1 }}</div>
                        <div class="review-rating">
                            {% for i in "12345" %}
                            {% if forloop.counter <= course.average_rating %}‚òÖ{% else %}‚òÜ{% endif %}
                            {% endfor %}
                        </div>
                        <div class="text-muted text-sm">{{ course.review_count }} reviews</div>
                    </div>
                    <div class="rating-bars" style="flex: 1;">
                        {% for i in "54321" %}
                        <div class="rating-bar">
                            <span style="width: 20px;">{{ i }}</span>
                            <span class="text-warning">‚òÖ</span>
                            <div class="rating-bar-fill">
                                {% with rating_distribution|default_if_none:'' as dist %}
                                <div style="width: {% widthratio rating_distribution|default:0 course.review_count|default:1 100 %}%;"></div>
                                {% endwith %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            {% for review in reviews %}
            <div class="review-card">
                <div class="review-header">
                    <div class="reviewer-avatar">
                        {{ review.student.first_name.0 }}{{ review.student.last_name.0 }}
                    </div>
                    <div class="reviewer-info">
                        <h4>{{ review.student.get_full_name }}</h4>
                        <div>
                            <span class="review-rating">
                                {% for i in "12345" %}
                                {% if forloop.counter <= review.rating %}‚òÖ{% else %}‚òÜ{% endif %}
                                {% endfor %}
                            </span>
                            <span class="text-muted text-sm">{{ review.created_at|timesince }} ago</span>
                        </div>
                    </div>
                </div>
                <p>{{ review.comment }}</p>
            </div>
            {% empty %}
            <p class="text-muted text-center">No reviews yet. Be the first to review this course!</p>
            {% endfor %}
        </section>
    </div>
</div>

<script>
function toggleModule(header) {
    const lessons = header.nextElementSibling;
    lessons.classList.toggle('open');
}

function playTrailer() {
    // Implement trailer playback
    alert('Trailer playback coming soon!');
}

// Open first module by default
document.addEventListener('DOMContentLoaded', function() {
    const firstModule = document.querySelector('.module-lessons');
    if (firstModule) {
        firstModule.classList.add('open');
    }
});
</script>
{% endblock %}
