name: Deploy to Production

on:
  push:
    branches:
      - master

env:
  PROJECT_NAME: ilmspace
  PROJECT_PATH: /var/www/ilmspace

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install Dependencies
        run: uv sync --frozen

      - name: Run Django Checks
        run: uv run python manage.py check
        env:
          DEBUG: 'True'
          SECRET_KEY: 'test-secret-key-for-ci'

  deploy:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check deployment secrets
        run: |
          echo "Checking if secrets are available..."
          if [ -z "${{ secrets.PRODUCTION_SERVER_IP }}" ]; then
            echo "âŒ PRODUCTION_SERVER_IP is EMPTY or not set"
            echo ""
            echo "âš ï¸  You need to add secrets to REPOSITORY settings, not Codespaces!"
            echo "Go to: https://github.com/Az1mbek-Xak1mov/CoursePlatform/settings/secrets/actions"
            echo "Click 'New repository secret' and add:"
            echo "  - PRODUCTION_SERVER_IP"
            echo "  - PRODUCTION_USER"  
            echo "  - PRODUCTION_SSH_KEY"
            exit 1
          else
            echo "âœ… PRODUCTION_SERVER_IP is set"
          fi

          if [ -z "${{ secrets.PRODUCTION_USER }}" ]; then
            echo "âŒ PRODUCTION_USER is EMPTY"
            exit 1
          else
            echo "âœ… PRODUCTION_USER is set"
          fi

          if [ -z "${{ secrets.PRODUCTION_SSH_KEY }}" ]; then
            echo "âŒ PRODUCTION_SSH_KEY is EMPTY"
            exit 1
          else
            echo "âœ… PRODUCTION_SSH_KEY is set (length: ${#PRODUCTION_SSH_KEY} chars)"
          fi
        env:
          PRODUCTION_SSH_KEY: ${{ secrets.PRODUCTION_SSH_KEY }}

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PRODUCTION_SERVER_IP }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          command_timeout: 30m
          script: |
            set -e
            
            echo "ðŸš€ Starting deployment..."
            
            # Install uv if not present
            if ! command -v uv &> /dev/null; then
              echo "ðŸ“¦ Installing uv package manager..."
              curl -LsSf https://astral.sh/uv/install.sh | sh
              export PATH="$HOME/.local/bin:$PATH"
            fi
            
            # Add uv to PATH for this session
            export PATH="$HOME/.local/bin:$PATH"
            
            # Verify uv is available
            echo "âœ… uv version: $(uv --version)"
            
            # Navigate to project directory (create if not exists)
            if [ ! -d "/var/www/ilmspace" ]; then
              echo "ðŸ“ Creating project directory..."
              echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S mkdir -p /var/www/ilmspace
              echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S chown $USER:$USER /var/www/ilmspace
              cd /var/www/ilmspace
              git clone https://github.com/Az1mbek-Xak1mov/CoursePlatform.git .
            else
              cd /var/www/ilmspace
              echo "ðŸ“¥ Pulling latest code..."
              git pull origin master
            fi
            
            # Create .env if not exists
            if [ ! -f ".env" ]; then
              echo "âš™ï¸ Creating .env file..."
              SECRET_KEY=$(python3 -c 'import secrets; print(secrets.token_urlsafe(50))')
              cat > .env << EOF
            DEBUG=False
            SECRET_KEY=$SECRET_KEY
            ALLOWED_HOSTS=${{ secrets.PRODUCTION_SERVER_IP }},localhost,127.0.0.1
            EOF
            fi
            
            # Create logs directory
            mkdir -p logs
            
            # Install/update dependencies with uv
            echo "ðŸ“¦ Installing dependencies..."
            uv sync --frozen || uv sync
            
            # Collect static files
            echo "ðŸ“¦ Collecting static files..."
            uv run python manage.py collectstatic --noinput
            
            # Run migrations
            echo "ðŸ”„ Running migrations..."
            uv run python manage.py migrate --noinput
            
            # Setup and restart systemd service
            if [ ! -f "/etc/systemd/system/ilmspace.service" ]; then
              echo "âš™ï¸ Creating systemd service..."
              echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S tee /etc/systemd/system/ilmspace.service > /dev/null << EOF
            [Unit]
            Description=IlmSpace Django Application
            After=network.target

            [Service]
            User=$USER
            Group=$USER
            WorkingDirectory=/var/www/ilmspace
            Environment="PATH=/var/www/ilmspace/.venv/bin:/home/$USER/.local/bin:/usr/local/bin:/usr/bin"
            ExecStart=/var/www/ilmspace/.venv/bin/gunicorn CoursePlatform.wsgi:application --bind 127.0.0.1:8000 --workers 3 --timeout 120
            Restart=always
            RestartSec=3

            [Install]
            WantedBy=multi-user.target
            EOF
              echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S systemctl daemon-reload
              echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S systemctl enable ilmspace
            fi
            
            # Setup nginx if not configured
            if [ ! -f "/etc/nginx/sites-available/ilmspace" ]; then
              echo "âš™ï¸ Creating nginx configuration..."
              echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S tee /etc/nginx/sites-available/ilmspace > /dev/null << EOF
            server {
                listen 80;
                server_name ${{ secrets.PRODUCTION_SERVER_IP }};
                
                client_max_body_size 100M;
                
                location /static/ {
                    alias /var/www/ilmspace/staticfiles/;
                    expires 30d;
                }
                
                location /media/ {
                    alias /var/www/ilmspace/media/;
                    expires 7d;
                }
                
                location / {
                    proxy_pass http://127.0.0.1:8000;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                }
            }
            EOF
              echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S ln -sf /etc/nginx/sites-available/ilmspace /etc/nginx/sites-enabled/
              echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S rm -f /etc/nginx/sites-enabled/default
              echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S nginx -t
            fi
            
            # Restart services
            echo "ðŸ”„ Restarting services..."
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S systemctl restart ilmspace || echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S systemctl start ilmspace
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S systemctl restart nginx || echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S systemctl start nginx
            
            # Check service status
            echo ""
            echo "ðŸ“Š Service status:"
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S systemctl status ilmspace --no-pager -l || true
            
            echo ""
            echo "âœ… Deployment completed successfully!"
            echo "ðŸŒ Your app is running at: http://${{ secrets.PRODUCTION_SERVER_IP }}"
